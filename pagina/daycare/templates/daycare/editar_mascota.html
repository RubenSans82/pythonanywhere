{# pagina/daycare/templates/daycare/editar_mascota.html #}
{% extends 'daycare/base.html' %}
{% load static %} # Asegúrate de cargar static

{% block title %}Editar Mascota - {{ mascota.nombre }}{% endblock %}

{% block content %}
    <h1 class="mb-4">Editar Datos de {{ mascota.nombre }}</h1>

    <div class="row justify-content-center">
        <div class="col-md-8 col-lg-6">
            <div class="card shadow-sm">
                <div class="card-body">
                     {# Mostrar errores generales del formulario si los hay #}
                    {% if form.non_field_errors %}
                        <div class="alert alert-danger">
                            {% for error in form.non_field_errors %}
                                <p>{{ error }}</p>
                            {% endfor %}
                        </div>
                    {% endif %}

                    {# Asegúrate de que el formulario use method="post" y enctype="multipart/form-data" para la subida de archivos #}
                    <form method="post" enctype="multipart/form-data">
                        {% csrf_token %}

                        {# --- Mostrar la foto actual si existe --- #}
                        <div id="existing-photo-section">
                            {% if mascota.foto %}
                                <div class="mb-3 text-center">
                                    <p>Foto actual:</p>
                                    <img src="{{ mascota.foto.url }}" alt="Foto de {{ mascota.nombre }}" class="img-thumbnail" style="max-height: 200px; max-width: 100%; object-fit: cover;">
 
                                     {# --- Botón Personalizado para Eliminar Foto --- #}
                                     {# Este botón NO envía el formulario. Usa type="button". #}
                                     {# Le damos un ID para poder seleccionarlo con JavaScript. #}
                                     <button type="button" id="delete-photo-button" class="btn btn-danger btn-sm mt-2">
                                         Eliminar Foto
                                     </button>
                                     {# --- Fin Botón Eliminar --- #}
 
                                </div>
                            {% else %}
                                 <div class="mb-3 text-center text-muted">
                                     <p>No hay foto actual.</p>
                                 </div>
                            {% endif %}
                         </div>
                        {# --- Fin Mostrar foto actual --- #}


                        {# --- Renderizar los campos del formulario, incluido el campo 'foto' --- #}

                        {# Campo Nombre #}
                        <div class="mb-3">
                            <label for="{{ form.nombre.id_for_label }}" class="form-label">{{ form.nombre.label }}:</label>
                            {{ form.nombre }}
                            {% for error in form.nombre.errors %}<div class="text-danger">{{ error }}</div>{% endfor %}
                        </div>

                         {# Campo Raza #}
                        <div class="mb-3">
                            <label for="{{ form.raza.id_for_label }}" class="form-label">{{ form.raza.label }}:</label>
                            {{ form.raza }}
                            {% for error in form.raza.errors %}<div class="text-danger">{{ error }}</div>{% endfor %}
                        </div>

                         {# Campo Fecha de Nacimiento #}
                        <div class="mb-3">
                            <label for="{{ form.fecha_nacimiento.id_for_label }}" class="form-label">{{ form.fecha_nacimiento.label }}:</label>
                            {{ form.fecha_nacimiento }}
                            {% for error in form.fecha_nacimiento.errors %}<div class="text-danger">{{ error }}</div>{% endfor %}
                        </div>

                         {# Campo Notas Médicas #}
                        <div class="mb-3">
                            <label for="{{ form.notas_medicas.id_for_label }}" class="form-label">{{ form.notas_medicas.label }}:</label>
                            {{ form.notas_medicas }}
                             {% if form.notas_medicas.help_text %}<div class="form-text">{{ form.notas_medicas.help_text|safe }}</div>{% endif %}
                            {% for error in form.notas_medicas.errors %}<div class="text-danger">{{ error }}</div>{% endfor %}
                        </div>

                        {# Campo Comportamiento Notas #}
                        <div class="mb-3">
                            <label for="{{ form.comportamiento_notas.id_for_label }}" class="form-label">{{ form.comportamiento_notas.label }}:</label>
                            {{ form.comportamiento_notas }}
                            {% if form.comportamiento_notas.help_text %}<div class="form-text">{{ form.comportamiento_notas.help_text|safe }}</div>{% endif %}
                             {% for error in form.comportamiento_notas.errors %}<div class="text-danger">{{ error }}</div>{% endfor %}
                        </div>


                        {# --- CAMPO FOTO (Renderiza input file + el widget de limpiar oculto por CSS) --- #}
                        {# La casilla 'Limpiar' y su label se ocultarán con los estilos que añadimos arriba #}
                        <div class="mb-3">
                           <label for="{{ form.foto.id_for_label }}" class="form-label">{{ form.foto.label }}:</label>

                           {# Renderiza el input de archivo y (si hay foto) el enlace, casilla y label (estos últimos ocultos por CSS) #}
                           {{ form.foto }}

                           {% if form.foto.help_text %}<div class="form-text">{{ form.foto.help_text|safe }}</div>{% endif %}
                            {% for error in form.foto.errors %}<div class="text-danger">{{ error }}</div>{% endfor %}

                            {# Placeholder para la vista previa de la NUEVA foto seleccionada #}
                            {# Este <img> se muestra con JS al seleccionar un nuevo archivo #}
                            <img id="photo-preview" src="#" alt="Vista previa de la nueva foto" class="img-thumbnail mt-2" style="display: none; max-height: 200px; max-width: 100%; object-fit: cover;">

                        </div>
                        {# --- Fin CAMPO FOTO --- #}


                        {# --- Fin Renderizado de campos --- #}


                        <button type="submit" class="btn btn-primary w-100 mt-3">Guardar Cambios</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    {# Opcional: Enlace para volver a los detalles de la mascota #}
    <div class="text-center mt-3">
         <a href="{% url 'daycare:detalle_mascota' mascota.pk %}" class="btn btn-outline-secondary">Cancelar</a> {# O volver al detalle #}
    </div>


{% endblock content %}

{% block extra_css %}
    <link rel="stylesheet" href="https://unpkg.com/flatpickr@4.6.13/dist/flatpickr.min.css"> {# Enlace CDN al CSS #}
    {# Si necesitas un tema específico, busca su CDN también #}
    <style>
        /* Oculta la casilla de verificación 'Limpiar' por defecto y su etiqueta */
        /* El ID de la casilla es típicamente 'id_NOMBRECAMPO-clear'. Para el campo 'foto' es 'foto-clear_id'. */
        #foto-clear_id,
        label[for="foto-clear_id"] {
            display: none; /* No mostrar el elemento */
        }
        /* Opcional: Si quieres ocultar también el texto "Limpiar: " y el enlace a la foto actual,
           requeriría CSS más complejo o renderizar el campo manualmente.
           Por ahora, solo ocultamos la casilla y su etiqueta. */
    </style>
{% endblock %}

{# --- Añadir JS de Flatpickr y tu JS de inicialización usando CDN/Static --- #}
{% block extra_js %}
    {# Primero la librería principal de Flatpickr desde CDN #}
    <script src="https://unpkg.com/flatpickr@4.6.13/dist/flatpickr.min.js"></script> {# Enlace CDN al JS #}

    {# Opcional: Si quieres la localización en español, usa su CDN. Inclúyela DESPUÉS del JS principal de Flatpickr #}
    <script src="https://unpkg.com/flatpickr@4.6.13/dist/l10n/es.js"></script> {# Enlace CDN a la localización en español #}


    {# Segundo, tu script personalizado para inicializarlo (este sí está en tu static) #}
    <script src="{% static 'daycare/js/date_picker_init.js' %}"></script> {# Tu archivo JS local #}
{% endblock %}