{# pagina/daycare/templates/daycare/editar_mascota.html #}
{% extends 'base.html' %}
{% load static %}

{% block title %}Editar Mascota - {{ mascota.nombre }}{% endblock %}

{# --- CSS para ocultar 'Limpiar' y estilos de Drag-and-Drop + Flatpickr --- #}
{# Asegúrate de que este bloque extra_css esté en la sección <head> de tu base.html #}
{% block extra_css %}
    {# Estilos de Flatpickr -- ASEGÚRATE de que esta línea NO esté comentada si no está en base.html #}
    <link rel="stylesheet" href="https://unpkg.com/flatpickr@4.6.13/dist/flatpickr.min.css"> {# Enlace CDN al CSS #}

    <style>
        /* Oculta la casilla de verificación 'Limpiar' manual y su etiqueta */
        /* Estos elementos ahora están dentro del div.hidden-clear-widget */
        #foto-clear_id, /* El ID de la casilla que añadimos manualmente */
        label[for="foto-clear_id"] { /* La etiqueta de la casilla manual */
             display: none;
        }

        /* Oculta el contenedor completo de la casilla 'Limpiar' manual */
        .hidden-clear-widget {
            display: none !important; /* Usa !important para asegurar que se oculte */
        }


        /* --- Estilos para el Área de Arrastrar y Soltar (Drop Zone) --- */
        .drop-zone {
            border: 2px dashed #007bff; /* Borde punteado azul por defecto */
            padding: 30px; /* Más padding para un área más grande */
            text-align: center;
            cursor: pointer; /* Indica que es interactivo */
            border-radius: 8px; /* Esquinas más redondeadas */
            color: #007bff; /* Color de texto a juego */
            transition: background-color 0.3s ease, border-color 0.3s ease; /* Transición suave */
            position: relative; /* Necesario para posicionar el input file y otros elementos dentro */
            min-height: 150px; /* Opcional: Dale una altura mínima para que no se colapse si no hay preview */
            display: flex; /* Usamos flexbox para centrar contenido vertical y horizontalmente */
            flex-direction: column; /* Elementos apilados verticalmente */
            justify-content: center; /* Centrado vertical */
            align-items: center; /* Centrado horizontal */
            overflow: hidden; /* Oculta cualquier cosa que sobresalga (ej: imagen muy grande) */
             /* margin-bottom: 15px; /* Añade margen si es necesario */
        }

        /* Estilo cuando un archivo es arrastrado SOBRE la zona */
        .drop-zone.dragover {
            background-color: #e9f2ff; /* Fondo azul muy claro */
            border-color: #0056b3; /* Borde azul más oscuro */
            color: #0056b3; /* Texto más oscuro */
        }

         /* Style for the actual file input: invisible and cover the zone */
         /* Este input es AHORA manualmente colocado dentro de .drop-zone */
         .drop-zone input[type="file"] {
             opacity: 0; /* Completamente transparente */
             position: absolute; /* Posicionamiento absoluto */
             z-index: 10; /* Asegura que esté por encima de otros contenidos para ser clickable */
             width: 100%; /* Cubre todo el ancho */
             height: 100%; /* Cubre toda la altura */
             top: 0;
             left: 0;
             cursor: pointer; /* Mantiene el cursor de puntero */
         }

         /* Style for the text inside the drop zone: ensure it's visible initially */
         .drop-zone .drop-zone-text {
             position: relative;
             z-index: 5; /* Por encima del fondo, por debajo del input oculto */
             pointer-events: none; /* Permite que los clics pasen a través del texto al input de archivo debajo */
             margin-bottom: 5px; /* Añade espacio entre las líneas de texto */
         }
          .drop-zone .drop-zone-text:last-child {
              margin-bottom: 0; /* No bottom margin for the last paragraph */
          }

         /* Style for the preview image *inside* the drop zone */
         /* ESTA IMAGEN AHORA ESTÁ DENTRO DE LA ZONA DE SOLTAR */
          .drop-zone #photo-preview {
              /* Ya tiene class="img-thumbnail mt-2" - quitamos mt-2 si está dentro del flex container */
              max-height: 100%; /* Limita la altura a la altura del contenedor flex */
              max-width: 100%; /* Limita el ancho al ancho del contenedor flex */
              object-fit: contain; /* Asegura que la imagen completa se vea sin distorsionarse */
              /* display: none; /* Esta propiedad la manejaremos con JavaScript */
              position: relative; /* Posicionamiento relativo dentro del contenedor flex */
              z-index: 5; /* Igual que el texto, para que se muestre */
               margin-top: 0; /* Asegurarse de no tener margen superior si está dentro del flex */
          }

     </style>
     {# Estilos de Flatpickr si no están en base #}
     {# <link rel="stylesheet" href="https://unpkg.com/flatpickr@4.6.13/dist/flatpickr.min.css"> #}
 {% endblock %}


 {% block content %}
     <h1 class="mb-4">Editar Datos de {{ mascota.nombre }}</h1>

     <div class="row justify-content-center">
         <div class="col-md-8 col-lg-6">
             <div class="card shadow-sm">
                 <div class="card-body">
                     {# Mostrar errores generales del formulario si los hay #}
                     {% if form.non_field_errors %}
                         <div class="alert alert-danger">
                             {% for error in form.non_field_errors %}
                                 <p>{{ error }}</p>
                             {% endfor %}
                         </div>
                     {% endif %}

                     {# Asegúrate de que el formulario use method="post" y enctype="multipart/form-data" para la subida de archivos #}
                     <form method="post" enctype="multipart/form-data">
                         {% csrf_token %}

                         {# --- Mostrar la foto actual si existe y añadir botón eliminar --- #}
                         {# Este div#existing-photo-section se usa para ocultar con JS cuando hay preview o eliminación #}
                         <div id="existing-photo-section">
                            {% if mascota.foto %}
                                <div class="mb-3 text-center">
                                    <p>Foto actual:</p>
                                    <img src="{{ mascota.foto.url }}" alt="Foto de {{ mascota.nombre }}" class="img-thumbnail" style="max-height: 200px; max-width: 100%; object-fit: cover;">

                                     {# --- Botón Personalizado para Eliminar Foto --- #}
                                     <button type="button" id="delete-photo-button" class="btn btn-danger btn-sm mt-2">
                                         Eliminar Foto
                                     </button>
                                     {# --- End Custom Delete Button --- #}

                                </div>
                            {% else %}
                                 {# Mostrar este mensaje si no hay foto actual #}
                                 <div class="mb-3 text-center text-muted">
                                     <p>No hay foto actual.</p>
                                 </div>
                            {% endif %}
                         </div> {# Fin div#existing-photo-section #}
                         {# --- Fin Mostrar foto actual y botón eliminar --- #}


                         {# --- Renderizar otros campos del formulario manualmente --- #}
                         {# Asegúrate de que tienes TODOS los campos necesarios aquí. Copia y pega tus bloques div.mb-3 #}

                         {# Ejemplo: Campo Nombre #}
                         <div class="mb-3">
                             <label for="{{ form.nombre.id_for_label }}" class="form-label">{{ form.nombre.label }}:</label>
                             {{ form.nombre }}
                             {% for error in form.nombre.errors %}<div class="text-danger">{{ error }}</div>{% endfor %}
                         </div>
                          {# Ejemplo: Campo Raza #}
                         <div class="mb-3">
                             <label for="{{ form.raza.id_for_label }}" class="form-label">{{ form.raza.label }}:</label>
                             {{ form.raza }}
                             {% for error in form.raza.errors %}<div class="text-danger">{{ error }}</div>{% endfor %}
                         </div>
                          {# Ejemplo: Campo Fecha de Nacimiento #}
                          <div class="mb-3">
                              <label for="{{ form.fecha_nacimiento.id_for_label }}" class="form-label">{{ form.fecha_nacimiento.label }}:</label>
                              {{ form.fecha_nacimiento }}
                              {% for error in form.fecha_nacimiento.errors %}<div class="text-danger">{{ error }}</div>{% endfor %}
                          </div>
                           {# Ejemplo: Campo Notas Médicas #}
                         <div class="mb-3">
                             <label for="{{ form.notas_medicas.id_for_label }}" class="form-label">{{ form.notas_medicas.label }}:</label>
                             {{ form.notas_medicas }}
                              {% if form.notas_medicas.help_text %}<div class="form-text">{{ form.notas_medicas.help_text|safe }}</div>{% endif %}
                             {% for error in form.notas_medicas.errors %}<div class="text-danger">{{ error }}</div>{% endfor %}
                         </div>
                          {# Ejemplo: Campo Comportamiento Notas #}
                         <div class="mb-3">
                             <label for="{{ form.comportamiento_notas.id_for_label }}" class="form-label">{{ form.comportamiento_notas.label }}:</label>
                             {{ form.comportamiento_notas }}
                             {% if form.comportamiento_notas.help_text %}<div class="form-text">{{ form.comportamiento_notas.help_text|safe }}</div>{% endif %}
                              {% for error in form.comportamiento_notas.errors %}<div class="text-danger">{{ error }}</div>{% endfor %}
                         </div>
                         {# Fin Renderizado Manual de Otros Campos #}


                         {# --- CAMPO FOTO (Renderizado Manual con Área Drag-and-Drop y Vista Previa DENTRO) --- #}
                         {# Ya NO usamos {{ form.foto }} para tener control total del HTML #}
                         <div class="mb-3">
                            {# La etiqueta para el campo foto #}
                            {{ form.foto.label_tag }}
                            {# Errores específicos del campo foto #}
                            {% for error in form.foto.errors %}<div class="text-danger">{{ error }}</div>{% endfor %}


                            {# --- El Área de Arrastrar y Soltar (Drop Zone) --- #}
                            {# Este div es donde el usuario arrastrará y soltará archivos. También será clickable. #}
                            {# La vista previa (#photo-preview) y el texto (.drop-zone-text) están DENTRO de este div #}
                            <div id="drop-zone" class="drop-zone">
                                 {# --- Input de Archivo Manual (Invisible) --- #}
                                 {# Creamos el input de archivo nosotros mismos. Es invisible pero cubre la zona. #}
                                 {# Es crucial que el atributo 'name' y 'id' coincidan con lo que Django espera ('foto' e 'id_foto'). #}
                                 <input type="file" name="{{ form.foto.name }}" id="{{ form.foto.id_for_label }}" accept="image/*">
                                 {# accept="image/*" abre el selector de archivo filtrado para imágenes #}
                                 {# Fin Input de Archivo Manual #}

                                 {# --- Texto de Instrucción (Visible inicialmente, oculto por JS al seleccionar/soltar) --- ##}
                                 {# Añadimos una clase CSS para poder seleccionarlos fácilmente con JS #}
                                 <p class="drop-zone-text">Arrastra y suelta una foto aquí</p>
                                 <p class="drop-zone-text">o haz clic para seleccionar</p>
                                 {# --- Fin Texto de Instrucción --- #}

                                 {# --- Placeholder para la vista previa (Oculta inicialmente, visible por JS al seleccionar/soltar) --- #}
                                 {# ESTA IMAGEN AHORA ESTÁ DENTRO DE LA ZONA DE SOLTAR #}
                                 <img id="photo-preview" src="#" alt="Vista previa de la nueva foto" class="img-thumbnail" style="display: none;"> {# CSS maneja el tamaño y object-fit #}
                                 {# alt es importante por accesibilidad #}
                                 {# --- Fin Placeholder Vista Previa --- #}

                             </div>
                             {# --- Fin Área de Arrastrar y Soltar --- #}

                            {# Ayuda del campo foto (aparecerá debajo de la zona de soltar) #}
                            {% if form.foto.help_text %}<div class="form-text">{{ form.foto.help_text|safe }}</div>{% endif %}


                             {# --- Widget de "Limpiar" Oculto Manual --- #}
                             {# Necesitamos añadir manualmente la casilla y etiqueta "Limpiar" para la lógica de la vista #}
                             {# Solo añadimos esto si la mascota ya tiene una foto existente. #}
                             {# Este div se oculta completamente con CSS (.hidden-clear-widget) #}
                             {% if mascota.foto %}
                                 <div class="hidden-clear-widget">
                                     {# Input checkbox para marcar la eliminación. Name: campo_name-clear, ID: el ID correcto. #}
                                     <input type="checkbox" name="{{ form.foto.name }}-clear" id="foto-clear_id">
                                     {# Etiqueta para la casilla #}
                                     <label for="foto-clear_id">Limpiar</label>
                                 </div>
                             {% endif %}
                             {# --- Fin Widget de "Limpiar" Oculto Manual --- #}


                             {# La vista previa ya no está aquí fuera, ahora está DENTRO de la zona de soltar #}


                        </div>
                         {# --- Fin CAMPO FOTO --- #}


                        {# --- Botón para Guardar Cambios --- #}
                        {# ASEGÚRATE de que este botón esté DENTRO de la etiqueta <form> #}
                        <button type="submit" class="btn btn-primary mt-3">Guardar Cambios</button>


                    </form>
                    {# Fin Formulario #}

                 </div> {# Fin card-body #}
             </div> {# Fin card #}
         </div> {# Fin col #}
     </div> {# Fin row #}


     {# Enlace para volver a los detalles de la mascota (FUERA del form) #}
     <div class="text-center mt-3">
          <a href="{% url 'daycare:detalle_mascota' mascota.pk %}" class="btn btn-outline-secondary">Cancelar</a>
     </div>


 {% endblock content %}

 {# Scripts JS (Flatpickr, tu JS personalizado con preview, delete, drag-drop) #}
 {# Asegúrate de que este bloque extra_js esté justo antes del cierre de </body> en tu base.html #}
 {% block extra_js %}
     {# Scripts de Flatpickr si los necesitas en esta página #}
     <script src="https://unpkg.com/flatpickr@4.6.13/dist/flatpickr.min.js"></script>
     <script src="https://unpkg.com/flatpickr@4.6.13/dist/l10n/es.js"></script>

     {# Tu script JS personalizado #}
     {# Este archivo contendrá las correcciones de los pasos anteriores y la lógica de visibilidad en la zona de soltar #}
     <script src="{% static 'daycare/js/date_picker_init.js' %}"></script>
 {% endblock %}